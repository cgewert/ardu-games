#include "TvGame.h"
#include "AnalogStickController.h"

#define MAX_SHOTS 5
#define MAX_BULLETS 1
#define MAX_ENEMIES 20

#define STATE_INACTIVE 0
#define STATE_ACTIVE 1
#define STATE_PENDING 2

#define TYPE_FRIENDLY 0
#define TYPE_ENEMY 1
#define LEVEL_ENTRY_LENGTH 3

struct Sprite {
    Rect bounds = Rect(0, 0, 1, 1);
    byte state = STATE_INACTIVE;
    byte type = TYPE_ENEMY;
    byte frame = 0;
    const unsigned char* bitmap;
};

struct Bullet {
    Rect bounds = Rect(0, 0, 1, 1);
    uint8_t state = STATE_INACTIVE;
    uint8_t type = TYPE_ENEMY;
};

const unsigned char titleGfx[] PROGMEM = {
  128, 64,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x55,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .........................................................#.#.#.#.#..............................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0x54,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................................................#..#...#.#.#..........................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x53,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .......................................................#.#.#..##..#...#.........................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0xA9,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................................................#.#.#.#.#.#..#........................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xAA,0xAA,0x40,0x00,0x00,0x00,0x00,0x00,0x00, // ......................................................#.#.#.#.#.#.#.#.#..#......................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x08,0xAA,0xD5,0x50,0x00,0x00,0x00,0x00,0x00,0x00, // ....................................................#...#.#.#.#.##.#.#.#.#.#....................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x25,0x5F,0x6A,0x20,0x00,0x00,0x00,0x00,0x00,0x00, // ..................................................#..#.#.#.#####.##.#.#...#.....................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xAF,0xFB,0x54,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................#..#..#.#.#.#########.##.#.#.#..................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x55,0x7F,0xF6,0xA0,0x00,0x00,0x00,0x00,0x00,0x00, // .................................................#.#.#.#.###########.##.#.#.....................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x15,0x7F,0xFF,0xAA,0x00,0x00,0x00,0x00,0x00,0x00, // ...................................................#.#.#.################.#.#.#.................................................
  0x00,0x00,0x00,0x00,0x00,0x02,0xAB,0xFF,0xFE,0xA8,0x00,0x00,0x00,0x00,0x00,0x00, // ..............................................#.#.#.#.#################.#.#.#...................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0xAA,0xFF,0xFF,0xAA,0x80,0x00,0x00,0x00,0x00,0x00, // ................................................#.#.#.#.#################.#.#.#.#...............................................
  0x00,0x00,0x00,0x00,0x00,0x0A,0x57,0xFF,0xFF,0xD5,0x50,0x00,0x00,0x00,0x00,0x00, // ............................................#.#..#.#.#####################.#.#.#.#.#............................................
  0x00,0x00,0x00,0x00,0x02,0xAA,0xBF,0xFF,0xFF,0xFA,0xAA,0xA0,0x00,0x00,0x00,0x00, // ......................................#.#.#.#.#.#.###########################.#.#.#.#.#.#.#.....................................
  0x00,0x00,0x00,0x00,0x00,0x4A,0xAF,0xFF,0xFF,0xED,0x50,0x00,0x00,0x00,0x00,0x00, // .........................................#..#.#.#.#.#######################.##.#.#.#............................................
  0x00,0x00,0x00,0x00,0x00,0x22,0xAB,0xFF,0xFF,0xF5,0x4A,0x00,0x00,0x00,0x00,0x00, // ..........................................#...#.#.#.#.######################.#.#.#..#.#.........................................
  0x00,0x00,0x00,0x00,0x00,0x09,0x55,0xFF,0xFF,0x55,0x20,0x00,0x00,0x00,0x00,0x00, // ............................................#..#.#.#.#.#################.#.#.#.#..#.............................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0xFF,0xFF,0x54,0x80,0x00,0x00,0x00,0x00,0x00, // ..................................................#.#.#.################.#.#.#..#...............................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x95,0xBF,0xFA,0xA9,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................#..#.#.##.###########.#.#.#.#..#................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x12,0xAF,0xFD,0x49,0x00,0x00,0x00,0x00,0x00,0x00, // ...................................................#..#.#.#.##########.#.#..#..#................................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0xFF,0xFA,0xA4,0x00,0x00,0x00,0x00,0x00,0x00, // ..................................................#.#.#.#############.#.#.#..#..................................................
  0x00,0x00,0x00,0x00,0x00,0x01,0xAF,0xFF,0xFF,0xFB,0xA0,0x00,0x00,0x00,0x00,0x00, // ...............................................##.#.#########################.###.#.............................................
  0x00,0x00,0x00,0x00,0x00,0x5F,0xFF,0xFF,0xFF,0xFF,0xFD,0x00,0x00,0x00,0x00,0x00, // .........................................#.###########################################.#........................................
  0x00,0x00,0x00,0x00,0x0B,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xD0,0x00,0x00,0x00,0x00, // ....................................#.##.#################################################.#....................................
  0x00,0x00,0x00,0x00,0xB7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFD,0x00,0x00,0x00,0x00, // ................................#.##.#########################################################.#................................
  0x00,0x00,0x00,0x02,0xFF,0xFE,0xAA,0xFF,0xFF,0xFF,0xFF,0xFF,0xA0,0x00,0x00,0x00, // ..............................#.###############.#.#.#.#.#########################################.#.............................
  0x00,0x00,0x00,0x3F,0xFF,0xFD,0xAD,0xFF,0xFF,0xFF,0xFD,0xFF,0xF8,0x00,0x00,0x00, // ..........................####################.##.#.##.###############################.##############...........................
  0x00,0x00,0x01,0x5F,0xDF,0xFF,0xD5,0xFF,0xFF,0xFF,0xFD,0x7F,0xFE,0x80,0x00,0x00, // .......................#.#.#######.###############.#.#.###############################.#.##############.#.......................
  0x00,0x00,0x0B,0xFA,0xBF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFA,0xAF,0xFF,0xA0,0x00,0x00, // ....................#.#######.#.#.###################################################.#.#.#.#############.#.....................
  0x00,0x00,0x57,0xDA,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x55,0xFF,0xFC,0x00,0x00, // .................#.#.#####.##.#.########################################################.#.#.#.###############..................
  0x00,0x01,0x7D,0x55,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xD5,0xAF,0x7D,0x7E,0x80,0x00, // ...............#.#####.#.#.#.#.###################################################.#.#.##.#.####.#####.#.######.#...............
  0x00,0x02,0xED,0x56,0xEA,0xD6,0xBF,0xFF,0xFF,0xF5,0x6F,0xD5,0xBE,0xAF,0xA0,0x00, // ..............#.###.##.#.#.#.##.###.#.#.##.#.##.#.##########################.#.#.##.######.#.#.##.#####.#.#.#####.#.............
  0x00,0x1F,0xAA,0xAA,0x91,0xA5,0x5F,0xFF,0xFF,0xAA,0xB5,0x6A,0xD5,0x55,0xE8,0x00, // ...........######.#.#.#.#.#.#.#.#..#...##.#..#.#.#.######################.#.#.#.#.##.#.#.##.#.#.##.#.#.#.#.#.#.####.#...........
  0x00,0x5D,0x54,0x08,0x00,0x00,0xAB,0xFF,0xFF,0xAA,0x95,0x2D,0x76,0x95,0x7A,0x00, // .........#.###.#.#.#.#......#...................#.#.#.###################.#.#.#.#..#.#.#..#.##.#.###.##.#..#.#.#.####.#.........
  0x01,0xF5,0x40,0x00,0x40,0x00,0x57,0xFF,0xFF,0x52,0x24,0xD5,0xA8,0x25,0x5E,0x80, // .......#####.#.#.#...............#...............#.#.###################.#.#..#...#..#..##.#.#.##.#.#.....#..#.#.#.####.#.......
  0x02,0xAA,0x40,0x01,0x00,0x00,0x15,0xFF,0xFF,0xEA,0x8A,0x02,0xAA,0x84,0x4B,0xA0, // ......#.#.#.#.#..#.............#...................#.#.####################.#.#.#...#.#.......#.#.#.#.#.#....#...#..#.###.#.....
  0x1F,0x50,0x00,0x04,0x00,0x00,0x56,0xFF,0xFF,0x2A,0x16,0x05,0x54,0x01,0x2A,0xE8, // ...#####.#.#.................#...................#.#.##.################..#.#.#....#.##......#.#.#.#.#.........#..#.#.#.###.#...
  0x15,0x48,0x01,0x10,0x00,0x00,0x02,0xBF,0xF5,0x91,0x0B,0x01,0x17,0x50,0x02,0xBC, // ...#.#.#.#..#..........#...#..........................#.#.##########.#.##..#...#....#.##.......#...#.###.#.#..........#.#.####..
  0x75,0x20,0x02,0x00,0x00,0x00,0x15,0x55,0xAA,0x0C,0x07,0x02,0xB8,0x90,0x04,0xAE, // .###.#.#..#...........#............................#.#.#.#.#.#.##.#.#.#.....##.......###......#.#.###...#..#.........#..#.#.###.
  0xDA,0x80,0x00,0x00,0x00,0x00,0x00,0xAA,0xA0,0x02,0x03,0x85,0xCE,0x94,0x00,0x23, // ##.##.#.#...............................................#.#.#.#.#.#...........#.......###....#.###..###.#..#.#............#...##
  0xA8,0x00,0x00,0x00,0x50,0x00,0x01,0x2A,0xA0,0x18,0x01,0x0B,0x70,0x80,0x00,0x15, // #.#.#............................#.#...................#..#.#.#.#.#........##..........#....#.##.###....#..................#.#.#
  0xD4,0x0C,0x00,0x01,0x40,0x00,0x00,0x02,0x80,0x0D,0x00,0x82,0x1C,0x00,0x00,0x02, // ##.#.#......##.................#.#............................#.#...........##.#........#.....#....###........................#.
  0x20,0x00,0x00,0x0A,0x80,0x00,0x00,0xB4,0x40,0x20,0x00,0x04,0x03,0x00,0x00,0x01, // ..#.........................#.#.#.......................#.##.#...#........#..................#........##.......................#
  0xA0,0x00,0x00,0x2A,0x80,0x00,0x01,0xB2,0x10,0x00,0x00,0x40,0x00,0x00,0x00,0x00, // #.#.......................#.#.#.#......................##.##..#....#.....................#......................................
  0x28,0x00,0x05,0x50,0x40,0x00,0x06,0xE0,0xA8,0x04,0x00,0x00,0x00,0x00,0x00,0x00, // ..#.#................#.#.#.#.....#...................##.###.....#.#.#........#..................................................
  0xA8,0x00,0x00,0xA8,0x70,0x00,0x1B,0x64,0x28,0x02,0x80,0x04,0x00,0x00,0x00,0x00, // #.#.#...................#.#.#....###...............##.##.##..#....#.#.........#.#............#..................................
  0x74,0x00,0x12,0xA5,0x28,0x00,0x4B,0xA0,0x92,0x02,0x00,0x01,0x00,0x00,0x00,0x00, // .###.#.............#..#.#.#..#.#..#.#............#..#.###.#.....#..#..#.......#................#................................
  0x5A,0x00,0x02,0xD2,0xB8,0x01,0xAD,0x50,0x08,0x00,0x00,0x00,0x00,0x28,0x00,0x00, // .#.##.#...............#.##.#..#.#.###..........##.#.##.#.#.#........#.....................................#.#...................
  0x6A,0x00,0x0B,0xAB,0x48,0x05,0xE9,0x48,0x0C,0x00,0x00,0x40,0x00,0x20,0x00,0x00, // .##.#.#.............#.###.#.#.##.#..#........#.####.#..#.#..#.......##...................#................#.....................
  0xAD,0x09,0x56,0xEB,0xE4,0x0D,0xA8,0x48,0x02,0x00,0x00,0x00,0x00,0x01,0x00,0x00, // #.#.##.#....#..#.#.#.##.###.#.#####..#......##.##.#.#....#..#.........#........................................#................
  0x6A,0x54,0x6D,0xB7,0x42,0x1E,0x40,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .##.#.#..#.#.#...##.##.##.##.###.#....#....####..#................####.#........................................................
  0xBB,0x06,0x36,0xD5,0x6B,0x9E,0x20,0x20,0x1F,0x80,0x00,0x00,0x03,0x82,0x80,0x00, // #.###.##.....##...##.##.##.#.#.#.##.#.###..####...#.......#........######.............................###.....#.#...............
  0xD4,0x81,0x49,0x2D,0x5F,0xFC,0x00,0x10,0x5E,0x00,0x00,0x00,0x00,0x02,0x00,0x00, // ##.#.#..#......#.#..#..#..#.##.#.#.###########.............#.....#.####.......................................#.................
  0x7E,0x80,0x0D,0xD5,0x7F,0xBE,0x00,0x11,0x48,0x00,0x00,0x00,0x00,0x20,0x00,0x00, // .######.#...........##.###.#.#.#.########.#####............#...#.#..#.....................................#.....................
  0x55,0x23,0x35,0x2B,0xFF,0xD0,0x20,0x02,0x08,0x00,0x00,0x10,0x00,0x00,0x00,0x00, // .#.#.#.#..#...##..##.#.#..#.#.############.#......#...........#.....#......................#....................................
  0x55,0xB5,0xAA,0x95,0x5D,0xD0,0x00,0x10,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .#.#.#.##.##.#.##.#.#.#.#..#.#.#.#.###.###.#...............#.........#..........................................................
  0xAA,0xAA,0x52,0x5B,0x55,0x40,0x00,0x00,0x08,0x00,0x80,0x00,0x00,0x00,0x00,0x00, // #.#.#.#.#.#.#.#..#.#..#..#.##.##.#.#.#.#.#..........................#...........#...............................................
  0xA8,0xAB,0x0A,0x95,0x55,0x70,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00, // #.#.#...#.#.#.##....#.#.#..#.#.#.#.#.#.#.###....................................#...............................................
  0x55,0x54,0x00,0x0A,0xAA,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .#.#.#.#.#.#.#..............#.#.#.#.#.#.#.......................................................................................
  0x05,0x54,0x00,0x05,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  // .....#.#.#.#.#...............#.#....#.....#.....................................................................................
};

const unsigned char gameOverGfx[] PROGMEM = {
  128, 64,
  0x52,0x55,0x55,0x5B,0x6A,0xAD,0xAD,0xFF,0xEA,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .#.#..#..#.#.#.#.#.#.#.#.#.##.##.##.#.#.#.#.##.##.#.##.############.#.#.........................................................
  0xAA,0x92,0xAA,0xAA,0xAA,0xD6,0xD6,0xFF,0xF4,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // #.#.#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.##.#.##.##.#.##.############.#..........................................................
  0x2A,0xA9,0x2A,0xAA,0xAA,0xB5,0x5B,0x7F,0xF5,0x07,0xDD,0x00,0x00,0x00,0x00,0x00, // ..#.#.#.#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.##.#.#.#.##.##.###########.#.#.....#####.###.#........................................
  0x52,0x54,0x95,0x55,0x55,0x56,0xD5,0xAE,0xFA,0x0B,0xFF,0x80,0x00,0x00,0x00,0x00, // .#.#..#..#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.##.##.#.#.##.#.###.#####.#.....#.###########.......................................
  0x15,0x4A,0xA4,0xAA,0xAA,0xAB,0x6D,0xB7,0x7A,0x8A,0x9F,0xF8,0x00,0x00,0x00,0x00, // ...#.#.#.#..#.#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.##.##.##.##.##.###.####.#.#...#.#.#..##########...................................
  0x42,0x54,0x95,0x55,0x55,0x55,0x55,0x6D,0xBD,0x77,0x57,0xFD,0x00,0x00,0x00,0x00, // .#....#..#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.##.##.##.####.#.###.###.#.#.#########.#................................
  0x29,0x12,0xA4,0x95,0x55,0x55,0x55,0xAD,0xDF,0x13,0xEA,0xFF,0xE0,0x00,0x00,0x00, // ..#.#..#...#..#.#.#..#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.#.##.#.##.###.#####...#..#####.#.#.###########.............................
  0x54,0xA8,0x52,0x55,0x55,0x55,0x5A,0xB6,0xBE,0xA5,0xD5,0x1F,0xE0,0x00,0x00,0x00, // .#.#.#..#.#.#....#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.##.#.#.##.##.#.#####.#.#..#.###.#.#.#...########.............................
  0x02,0x25,0x15,0x49,0x55,0x55,0x55,0x56,0xD7,0x51,0xFD,0xC5,0xF8,0x00,0x00,0x00, // ......#...#..#.#...#.#.#.#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.##.##.#.###.#.#...#######.###...#.######...........................
  0x49,0x52,0xA4,0xA5,0x2A,0xAA,0xAA,0xB5,0x6F,0x05,0xFF,0xF5,0x7E,0x00,0x00,0x00, // .#..#..#.#.#..#.#.#..#..#.#..#.#..#.#.#.#.#.#.#.#.#.#.#.#.##.#.#.##.####.....#.#############.#.#.######.........................
  0x24,0x48,0x12,0x95,0x55,0x55,0x55,0x5B,0xAB,0x25,0x3F,0xFA,0xBF,0x00,0x00,0x00, // ..#..#...#..#......#..#.#..#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.##.###.#.#.##..#..#.#..###########.#.#.######........................
  0x01,0x25,0x48,0xA2,0x4A,0xAA,0xAA,0xAA,0xDA,0x8A,0xBF,0xFD,0xFF,0x00,0x00,0x00, // .......#..#..#.#.#..#...#.#...#..#..#.#.#.#.#.#.#.#.#.#.#.#.#.#.##.##.#.#...#.#.#.############.#########........................
  0x00,0xA0,0x4A,0x29,0x29,0x55,0x55,0x55,0x6C,0xA2,0x05,0xFE,0xBF,0x80,0x00,0x00, // ........#.#......#..#.#...#.#..#..#.#..#.#.#.#.#.#.#.#.#.#.#.#.#.##.##..#.#...#......#.########.#.#######.......................
  0x05,0x10,0xA2,0x94,0x94,0x95,0x55,0x55,0xAA,0x40,0x52,0xFC,0xBF,0x80,0x00,0x00, // .....#.#...#....#.#...#.#..#.#..#..#.#..#..#.#.#.#.#.#.#.#.#.#.##.#.#.#..#.......#.#..#.######..#.#######.......................
  0x00,0x92,0x28,0x42,0x45,0x52,0xAA,0xAA,0xAA,0x20,0x12,0x3E,0x8F,0x80,0x00,0x00, // ........#..#..#...#.#....#....#..#...#.#.#.#..#.#.#.#.#.#.#.#.#.#.#.#.#...#........#..#...#####.#...#####.......................
  0x00,0x08,0x82,0x95,0x29,0x2A,0x55,0x55,0x69,0x50,0xA5,0xDE,0x7F,0x80,0x00,0x00, // ............#...#.....#.#..#.#.#..#.#..#..#.#.#..#.#.#.#.#.#.#.#.##.#..#.#.#....#.#..#.###.####..########.......................
  0x00,0x00,0x40,0x90,0xA4,0x92,0xAA,0xAA,0xAC,0x10,0x10,0x5E,0x8F,0x80,0x00,0x00, // .................#......#..#....#.#..#..#..#..#.#.#.#.#.#.#.#.#.#.#.##.....#.......#.....#.####.#...#####.......................
  0x00,0x00,0x12,0x4A,0x12,0x49,0x2A,0xAA,0xB0,0x45,0x42,0xAE,0xBE,0x80,0x00,0x00, // ...................#..#..#..#.#....#..#..#..#..#..#.#.#.#.#.#.#.#.##.....#...#.#.#....#.#.#.###.#.#####.#.......................
  0x00,0x00,0x10,0x41,0x49,0x54,0xA5,0x55,0x58,0x20,0x00,0xAF,0x1F,0x80,0x00,0x00, // ...................#.....#.....#.#..#..#.#.#.#..#.#..#.#.#.#.#.#.#.##.....#.............#.#.####...######.......................
  0x00,0x00,0x00,0x94,0x24,0x25,0x2A,0xAA,0xA8,0x04,0x00,0x2E,0x3F,0x00,0x00,0x00, // ........................#..#.#....#..#....#..#.#..#.#.#.#.#.#.#.#.#.#........#............#.###...######........................
  0x00,0x00,0x00,0x02,0x92,0x94,0x92,0xA9,0x54,0x04,0x00,0x06,0x9F,0x80,0x00,0x00, // ..............................#.#..#..#.#..#.#..#..#..#.#.#.#..#.#.#.#.......#...............##.#..######.......................
  0x00,0x00,0x00,0x10,0x44,0x45,0x49,0x55,0x50,0x08,0x00,0x02,0x3F,0x00,0x00,0x00, // ...........................#.....#...#...#...#.#.#..#..#.#.#.#.#.#.#........#.................#...######........................
  0x00,0x00,0x00,0x05,0x12,0x51,0x25,0x2A,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00, // .............................#.#...#..#..#.#...#..#..#.#..#.#.#....................................#####........................
  0x00,0x00,0x04,0x00,0x04,0x8A,0x92,0x94,0x00,0x00,0x00,0x10,0x3E,0x00,0x00,0x00, // .....................#...............#..#...#.#.#..#..#.#..#.#.............................#......#####.........................
  0x00,0x10,0x00,0x20,0x04,0xA0,0x4A,0x50,0x00,0x40,0x00,0x1A,0x9E,0x00,0x00,0x00, // ...........#..............#..........#..#.#......#..#.#..#.#.............#.................##.#.#..####.........................
  0x00,0x00,0x00,0x00,0x02,0x15,0x21,0x10,0x00,0x80,0x00,0x15,0x7E,0x00,0x00,0x00, // ......................................#....#.#.#..#....#...#............#..................#.#.#.######.........................
  0x00,0x00,0x00,0x01,0x02,0x40,0x95,0x50,0x00,0x50,0x00,0x15,0x3C,0x00,0x00,0x00, // ...............................#......#..#......#..#.#.#.#.#.............#.#...............#.#.#..####..........................
  0x00,0x00,0x00,0x00,0x08,0x94,0x40,0x80,0x09,0x10,0x00,0x07,0xFC,0x00,0x00,0x00, // ....................................#...#..#.#...#......#...........#..#...#.................#########..........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0x40,0x00,0x88,0x00,0x0B,0xFC,0x00,0x00,0x00, // ..................................................#.#.#..#..............#...#...............#.########..........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x24,0x00,0x14,0xF8,0x00,0x00,0x00, // .......................................................#..................#..#.............#.#..#####...........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x41,0x21,0x00,0x0A,0xF8,0x04,0x00,0x00, // .....................................................#.#.........#.....#..#....#............#.#.#####........#..................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x24,0x00,0x00,0xB5,0x78,0x0F,0x00,0x00, // ........................................................#.........#..#..................#.##.#.#.####.......####................
  0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x01,0x12,0x00,0x14,0xA1,0x1C,0x07,0xC0,0x00, // .....................................................#.........#...#..#............#.#..#.#....#...###.......#####..............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x08,0x00,0x01,0x44,0xAE,0x05,0xF0,0x00, // ..............................................................#.....#..................#.#...#..#.#.###......#.#####............
  0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x01,0x48,0x00,0x05,0x44,0x17,0x02,0xF8,0x00, // ....................................................#.#........#.#..#................#.#.#...#.....#.###......#.#####...........
  0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x0E,0xA0,0x2C,0x02,0x10,0x4B,0x01,0xF8,0x00, // .....................................................#......###.#.#.......#.##........#....#.....#..#.##.......######...........
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x38,0x23,0x80,0x94,0x2B,0x80,0x78,0x00, // ..............................................................#...###.....#...###.......#..#.#....#.#.###........####...........
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0xA0,0x00,0x41,0x40,0x8B,0x00,0xFC,0x00, // ............................................................#.#.#.#..............#.....#.#......#...#.##........######..........
  0x00,0x00,0x00,0x00,0x00,0x00,0x14,0x0A,0xA8,0x00,0x28,0xB4,0x09,0x14,0x1C,0x00, // ...................................................#.#......#.#.#.#.#.............#.#...#.##.#......#..#...#.#.....###..........
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xA1,0x40,0xA4,0xD2,0x52,0x05,0xF0,0x00, // .............................................................#..#.#....#.#......#.#..#..##.#..#..#.#..#......#.#####............
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x56,0x14,0x28,0x14,0x79,0x20,0x22,0xF0,0x00, // .......................................................#.#.#.##....#.#....#.#......#.#...####..#..#.......#...#.####............
  0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0x2D,0x23,0x42,0xA1,0x7C,0x80,0x42,0xA0,0x00, // ..................................................#.#.#...#.##.#..#...##.#....#.#.#....#.#####..#........#....#.#.#.............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xAE,0x01,0x28,0x24,0xFF,0x40,0x28,0xC0,0x00, // ........................................................#.#.###........#..#.#.....#..#..########.#........#.#...##..............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x26,0x01,0x00,0x29,0xFE,0xA0,0xAF,0xC0,0x00, // ..........................................................#..##........#..........#.#..########.#.#.....#.#.######..............
  0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x36,0x40,0x00,0x28,0xFF,0xA0,0x57,0x80,0x00, // .....................................................#....##.##..#................#.#...#########.#......#.#.####...............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x80,0x00,0x09,0xFD,0xC5,0x3F,0x00,0x00, // .........................................................#.#.#..#...................#..#######.###...#.#..######................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x56,0x40,0x00,0x00,0xF8,0x74,0xAF,0x00,0x00, // .........................................................#.#.##..#......................#####....###.#..#.#.####................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x80,0x00,0x0B,0xE1,0x95,0x7E,0x00,0x00, // .........................................................#.#.#..#...................#.#####....##..#.#.#.######.................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x80,0x00,0x01,0xE0,0xD5,0xBE,0x00,0x00, // .........................................................#.#.#..#......................####.....##.#.#.##.#####.................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x77,0x05,0x00,0x01,0xE0,0x55,0x78,0x00,0x00, // .......................................................#.###.###.....#.#...............####......#.#.#.#.####...................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0xC1,0x00,0x01,0x60,0x54,0x00,0x00,0x00, // ..........................................................##..####.....#...............#.##......#.#.#..........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x64,0x40,0x00,0x0A,0xC0,0x2A,0x00,0x00,0x00, // .......................................................#.##..#...#..................#.#.##........#.#.#.........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA4,0x00,0x00,0x03,0xE0,0x15,0x00,0x00,0x00, // ........................................................#.#..#........................#####........#.#.#........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x68,0x00,0x01,0x17,0x80,0x0A,0x00,0x00,0x00, // .......................................................#.##.#..................#...#.####...........#.#.........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x2A,0x00,0xA0,0x8B,0xC0,0x0A,0x80,0x00,0x00, // .......................................................#..#.#.#.........#.#.....#...#.####..........#.#.#.......................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x41,0x20,0x40,0x2F,0x00,0x05,0x00,0x00,0x00, // .........................................................#.....#..#......#........#.####.............#.#........................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x2D,0x20,0x0B,0x00,0x01,0x40,0x00,0x00, // ..........................................................#....#..#.##.#..#.........#.##...............#.#......................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x92,0x98,0x0B,0x80,0x02,0x80,0x00,0x00, // .........................................................#......#..#..#.#..##.......#.###.............#.#.......................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x2A,0xAE,0x0B,0x80,0x00,0xA0,0x00,0x00, // .........................................................#........#.#.#.#.#.###.....#.###...............#.#.....................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x95,0x50,0x17,0x00,0x00,0x40,0x00,0x00, // ................................................................#..#.#.#.#.#.......#.###.................#......................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA5,0x14,0x0F,0x00,0x00,0x50,0x00,0x00, // ................................................................#.#..#.#...#.#......####.................#.#....................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x2A,0x00,0x3F,0x00,0x00,0x00,0x00,0x00, // ...............................................................#..#.#.#...........######........................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0x02,0x2F,0x00,0x00,0x08,0x00,0x00, // ................................................................#..#..#.......#...#.####....................#...................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x48,0x05,0xBE,0x00,0x00,0x00,0x00,0x00  // ...............................................................#.#..#........#.##.#####.........................................
};

const unsigned char spaceshipGfx[] PROGMEM = {
  8,8,
  B00110000, // ..##....
  B00101000, // ..#.#...
  B11110110, // ####.##.
  B10001011, // #...#.##
  B10001011, // #...#.##
  B11110110, // ####.##.
  B00101000, // ..#.#...
  B00110000  // ..##....
};

const unsigned char enemyGfx[] PROGMEM = {
  8, 8,
  B00011110,
  B00100001,
  B01000101,
  B10000001,
  B10111101,
  B10000001,
  B10011101,
  B01111110
};

const unsigned int level1[] PROGMEM = {
    8,          // number of entries
    60,         // Level time in seconds
    
    5, 1, 20,   // Spawn enemy type 1 in second 5 at y position 20
    6, 1, 30,
    7, 1, 40,
    8, 1, 50,

    15, 1, 10,
    15, 1, 20,
    15, 1, 30,
    15, 1, 40
};

byte gamestate = 0;
byte nextGamestate = 0;
TvGame game;
AnalogStickController controller;

Sprite player;
Sprite enemies[MAX_ENEMIES];
Bullet shots[MAX_SHOTS];
//Bullet bullets[MAX_BULLETS];

const unsigned int* currentLevel;
unsigned long levelStartTime = 0;
unsigned long timeElapsed = 0;
unsigned long levelMaxTime = 0;

uint8_t levelCursor = 0;
uint8_t levelEntries = 0;
uint16_t playerScore = 0;
uint8_t playerLives = 0;

void setup() {
    game = TvGame(128, 64);
    game.begin();
    game.setFps(20);
    game.setFont(font4x6);
    controller = AnalogStickController();
    controller.begin();

    player = Sprite();
    player.type = TYPE_FRIENDLY;
    player.state = STATE_ACTIVE;
    player.bounds.x = 0;
    player.bounds.y = 0;
    player.bounds.width = 8;
    player.bounds.height = 8;

    for (byte i = 0; i < MAX_ENEMIES; i++) {
        enemies[i] = Sprite();
    }
    for (byte i = 0; i < MAX_SHOTS; i++) {
        shots[i] = Bullet();
    }
}

void newGame() {
    player.bounds.x = 0;
    player.bounds.y = game.height /2;
    playerScore = 0;
    playerLives = 3;

    for (byte i = 0; i < MAX_ENEMIES; i++) {
        enemies[i].state = STATE_INACTIVE;
    }
    for (byte i = 0; i < MAX_SHOTS; i++) {
        shots[i].state = STATE_INACTIVE;
    }

    levelStartTime = millis();
    levelCursor = 0;

    currentLevel = level1;
    levelEntries = (uint8_t)pgm_read_byte(currentLevel);
    levelMaxTime = (uint8_t)pgm_read_byte(currentLevel +1);
}

byte nextFreeEnemyIndex() {
    for (byte i = 0; i < MAX_ENEMIES; i++) {
        if (enemies[i].state == STATE_INACTIVE) return i;
    }
    return MAX_ENEMIES;
}

byte nextFreeShotIndex() {
    for (byte i = 0; i < MAX_SHOTS; i++) {
        if (shots[i].state == STATE_INACTIVE) return i;
    }
    return MAX_SHOTS;
}

void newShot() {
    byte idx = nextFreeShotIndex();
    if (idx < MAX_SHOTS) {
        shots[idx] = Bullet();
        shots[idx].state = STATE_ACTIVE;
        shots[idx].type = TYPE_FRIENDLY;
        shots[idx].bounds.x = player.bounds.x +player.bounds.width;
        shots[idx].bounds.y = player.bounds.y +player.bounds.height /2;
        shots[idx].bounds.width = 2;
        shots[idx].bounds.height = 1;
    }
}

void newEnemy(uint8_t enemyType = 0, float y = 0) {
    int idx = nextFreeEnemyIndex();
    if (idx < MAX_ENEMIES) {
        enemies[idx] = Sprite();
        enemies[idx].bounds = Rect(
            game.width - 9,
            y,
            8, 8
        );
        enemies[idx].state = 1;
        enemies[idx].type = TYPE_ENEMY;
        enemies[idx].bitmap = enemyGfx;
    }
}

void drawStatusText() {
    game.setFont(font4x6);
    game.setCursor(0, 0);
    game.TV.print((int)levelCursor);
    game.setCursor(25, 0);
    game.TV.print(timeElapsed);
    game.setCursor(45, 0);
    game.TV.print(game.currentFps);

    game.setCursor(70, 0);
    game.TV.print((int)playerLives);

    game.setCursor(85, 0);
    game.TV.print(playerScore);
}

void loop() {
    if (!game.nextFrame()) return;
    controller.updateControllerState();
    byte i = 0;
    byte k = 0;
    byte idx;

    switch (gamestate) {

        // Title screen
        case 0:
            game.drawBitmap(0, 0, titleGfx);
            game.drawCenteredText(game.height -10, "Press button to start");
            if (controller.justPressed(BUTTON_A)) {
                game.tone(500, 10);
                newGame();
                nextGamestate = 1;
            }
            break;

        // Main game
        case 1:
            timeElapsed = (millis() -levelStartTime) /1000;

            // Level end is depending on time elapsed
            if (timeElapsed == levelMaxTime) {
                nextGamestate = 2;
                break;
            }

            // Spaceship control
            if (abs(controller.getRelativeX()) > 0.05) {
                player.bounds.x += controller.getRelativeX() *2;
                if (player.bounds.x + player.bounds.width > game.width) player.bounds.x = game.width - player.bounds.width;
                if (player.bounds.x < 0) player.bounds.x = 0;
            }
            if (abs(controller.getRelativeY()) > 0.05) {
                player.bounds.y += controller.getRelativeY() * 2;
                if (player.bounds.y + player.bounds.height > game.height) player.bounds.y = game.height - player.bounds.height;
                if (player.bounds.y < 0) player.bounds.y = 0;
            }

            // Player bullets
           for (i = 0; i < MAX_SHOTS; i++) {
               if (shots[i].state != STATE_INACTIVE) {
                   if (shots[i].bounds.x +shots[i].bounds.width < game.width) {
                       shots[i].bounds.x += 1.5;
                   } else {
                       shots[i].state = STATE_INACTIVE;
                   }
               }
           }

            // Move enemies
            for (i = 0; i < MAX_ENEMIES; i++) {
                if (enemies[i].state != STATE_INACTIVE) {
                    if (enemies[i].bounds.x > 0) {
                        enemies[i].bounds.x--;
                    } else {
                        enemies[i].state = STATE_INACTIVE;
                    }
                }
            }


            // Add enemies according to level map
            if (game.frameCount == 0) {
                while (levelCursor < levelEntries && (int)pgm_read_byte_near(currentLevel + 2 + (levelCursor * LEVEL_ENTRY_LENGTH)) == timeElapsed) {
                    newEnemy(
                        (int)pgm_read_byte_near(currentLevel + 3 + (levelCursor * LEVEL_ENTRY_LENGTH)),
                        (int)pgm_read_byte_near(currentLevel + 4 + (levelCursor * LEVEL_ENTRY_LENGTH))
                    );
                    levelCursor++;
                }
            }

            // Fire button
            if (controller.justPressed(BUTTON_A)) {
                newShot();
            }

            // Collision detection
            for (i = 0; i < MAX_ENEMIES; i++) {
                if (enemies[i].state != STATE_INACTIVE) {
                    for (k = 0; k < MAX_SHOTS; k++) {
                        if (shots[k].state != STATE_INACTIVE) {
                            if (game.collide(enemies[i].bounds, shots[k].bounds)) {
                                shots[k].state = STATE_INACTIVE;
                                enemies[i].state = STATE_INACTIVE;
                                // TODO Ton ausgeben
                                // TODO Score hochzählen
                                playerScore += 10;
                            }
                        }
                    }
                }

                if (enemies[i].state != STATE_INACTIVE) {
                    if (game.collide(enemies[i].bounds, player.bounds)) {
                        if (playerLives > 0) {
                            enemies[i].state = STATE_INACTIVE;
                            playerLives--;
                        } else {
                            nextGamestate = 2;
                        }
                    }
                }
            }

            // Draw the game state
            game.clearScreen();
            game.drawBitmap(player.bounds.x, player.bounds.y, spaceshipGfx);

            // Player shots
            for (i = 0; i < MAX_SHOTS; i++) {
                if (shots[i].state != STATE_INACTIVE) {
                    game.fillRect(
                        shots[i].bounds.x,
                        shots[i].bounds.y,
                        shots[i].bounds.width,
                        shots[i].bounds.height
                    );
                }
            }

            // Enemies
            for (i = 0; i < MAX_ENEMIES; i++) {
                if (enemies[i].state != STATE_INACTIVE) {
                    game.drawBitmap(
                        enemies[i].bounds.x,
                        enemies[i].bounds.y,
                        enemies[i].bitmap
                    );
                }
            }

            // TODO Enemy bullets

            drawStatusText();
            break;

        // Game over screen
        case 2:
            game.drawBitmap(0, 0, gameOverGfx);
            if (controller.justPressed(BUTTON_A)) {
                game.tone(500, 10);
                nextGamestate = 0;
            }
            break;
    }

    gamestate = nextGamestate;
}

